<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GA5 Unit 4 – Stumbling upon the Past (Practice)</title>
  <style>
    /* ====== Dark / GA-style aesthetic (no external libs) ====== */
    :root{
      --bg0:#0b1320;
      --bg1:#0e1b2c;
      --card:rgba(255,255,255,0.06);
      --card2:rgba(255,255,255,0.08);
      --line:rgba(255,255,255,0.12);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.68);
      --muted2:rgba(255,255,255,0.55);
      --good:rgba(120,255,170,0.20);
      --bad:rgba(255,120,120,0.18);
      --accent:rgba(120,170,255,0.28);
      --accent2:rgba(120,170,255,0.18);
      --shadow:0 18px 60px rgba(0,0,0,0.45);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: "Century Gothic", "AppleGothic", "URW Gothic L", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, #163256 0%, transparent 55%),
        radial-gradient(900px 600px at 90% 20%, #2a2f63 0%, transparent 50%),
        radial-gradient(900px 700px at 20% 90%, #0f3a3a 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 18px;
    }

    .app{ max-width:1180px; margin:0 auto; }

    /* ===== Header ===== */
    .topbar{
      display:flex;
      align-items:center;
      gap:18px;
      padding:18px 20px;
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .topbar::after{
      content:"";
      position:absolute;
      inset:-60px -120px auto auto;
      width:420px; height:220px;
      background: radial-gradient(circle at 30% 40%, rgba(255,255,255,0.12), transparent 60%);
      transform: rotate(-8deg);
      pointer-events:none;
    }

    .logo{
      width:54px; height:54px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; }

    .titlewrap{ flex:1 1 auto; min-width: 260px; }
    .title{
      font-size:42px;
      font-weight:700;
      letter-spacing:0.3px;
      line-height:1.05;
      margin:0 0 6px 0;
    }
    .subtitle{
      margin:0;
      font-size:18px;
      color:var(--muted);
      letter-spacing:0.2px;
    }

    .chips{
      display:flex;
      gap:12px;
      flex:0 0 auto;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      padding:12px 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color:var(--muted);
      font-weight:600;
      min-width:150px;
      text-align:center;
      backdrop-filter: blur(6px);
    }
    .chip b{ color: var(--text); }

    /* ===== Layout ===== */
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.45fr 0.9fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
      .chip{ min-width: 140px; }
      .title{ font-size:34px; }
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{ padding:18px; }

    /* ===== Left (Task) ===== */
    .section-tag{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      font-weight:700;
      letter-spacing:0.2px;
      margin-bottom:10px;
    }
    .question{
      font-size:22px;
      line-height:1.35;
      margin:0 0 14px;
      white-space:pre-line;
    }

    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:560px){
      .options{ grid-template-columns: 1fr; }
    }

    .opt-btn{
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      text-align:left;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .opt-btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.09);
      border-color: rgba(255,255,255,0.18);
    }
    .opt-btn:disabled{
      opacity:0.6;
      cursor:default;
      transform:none;
    }

    /* ===== Feedback ===== */
    .feedback{
      margin-top:14px;
      border-radius:18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.18);
      padding:14px 14px;
      color: var(--muted);
      min-height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .feedback .msg{
      font-size:16px;
      line-height:1.35;
      flex:1 1 auto;
      min-width:240px;
    }
    .feedback.good{
      background: var(--good);
      border-color: rgba(120,255,170,0.28);
      color: rgba(255,255,255,0.92);
    }
    .feedback.bad{
      background: var(--bad);
      border-color: rgba(255,120,120,0.28);
      color: rgba(255,255,255,0.92);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:12px 16px;
      font-weight:700;
      cursor:pointer;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border:1px solid rgba(255,255,255,0.14);
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.11); }
    .btn.primary{ background: var(--accent); border-color: rgba(120,170,255,0.28); }
    .btn.primary:hover{ background: rgba(120,170,255,0.34); }
    .btn:disabled{ opacity:0.5; cursor:default; transform:none; }

    /* ===== Right panel ===== */
    .panel-title{
      margin:0 0 10px;
      font-size:18px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:0.2px;
    }
    .panel-block{
      border-radius:18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.18);
      padding:14px;
      margin-bottom:12px;
    }
    .kpi{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-weight:700;
    }
    .kpi b{ color: var(--text); }

    .progress-wrap{
      margin-top:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      overflow:hidden;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background: rgba(120,170,255,0.35);
    }

    .howto{
      margin:0;
      padding-left:18px;
      color: var(--muted);
      line-height:1.45;
    }

    .vocab-list{
      color: var(--muted);
      line-height:1.55;
      margin:0;
      padding-left: 16px;
    }
    .vocab-list li{ margin:4px 0; }

    .pill{
      display:inline-block;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-weight:700;
      font-size:13px;
      margin-bottom:10px;
    }

    /* ===== Spelling (click tiles) ===== */
    #spelling-area{ display:none; margin-top:6px; }
    .spelling-prompt{
      font-size:18px;
      color: var(--muted);
      margin: 0 0 10px;
      line-height:1.45;
    }
    .built-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .built-box{
      flex:1 1 auto;
      min-height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding:10px 12px;
      display:flex;
      align-items:center;
      font-size:18px;
      letter-spacing:0.8px;
    }
    .tile-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:12px;
    }
    .tile-btn{
      min-width:46px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease;
    }
    .tile-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.10); }
    .tile-btn:disabled{ opacity:0.35; cursor:default; transform:none; }

    .hint{
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      line-height:1.4;
      display:none;
    }

    /* ===== Reading comprehension (final) ===== */
    .passage{
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding:14px;
      color: var(--muted);
      line-height:1.5;
      margin-top:10px;
      white-space: pre-line;
    }

    .footer-note{
      margin-top:12px;
      color: var(--muted2);
      font-size:13px;
      line-height:1.45;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- ====== HEADER ====== -->
    <div class="topbar">
      <div class="logo">
        <!-- Put your file in the SAME repo folder as index.html (e.g., logo.png) -->
        <img src="logo.png" alt="Logo" />
      </div>

      <div class="titlewrap">
        <h1 class="title">Unit 4 – Stumbling upon the Past</h1>
        <p class="subtitle">Vocabulary practice · Meaning → Use → Spelling (Unscramble) → Reading Comprehension · Review Mode</p>
      </div>

      <div class="chips">
        <div class="chip">Progress: <b id="chip-progress">1/??</b></div>
        <div class="chip">Score: <b id="chip-score">0</b></div>
        <div class="chip">Mode: <b id="chip-mode">Main</b></div>
      </div>
    </div>

    <!-- ====== MAIN GRID ====== -->
    <div class="grid">
      <!-- LEFT: TASK -->
      <div class="card">
        <div class="card-inner">
          <div class="section-tag" id="section-tag">Vocabulary – Meaning</div>

          <div class="question" id="question-text">Loading…</div>

          <!-- Multiple-choice area -->
          <div class="options" id="options-container"></div>

          <!-- Spelling area (click tiles) -->
          <div id="spelling-area">
            <div class="spelling-prompt" id="spelling-prompt"></div>

            <div class="built-row">
              <div class="built-box" id="built-box"></div>
              <button class="btn" id="clear-built" type="button">Clear</button>
            </div>

            <div class="tile-row" id="tile-row"></div>

            <div class="actions">
              <button class="btn primary" id="check-spelling" type="button">Check</button>
              <button class="btn" id="try-again" type="button" style="display:none;">Try again</button>
            </div>

            <div class="hint" id="spelling-hint"></div>
          </div>

          <!-- Feedback + Next -->
          <div class="feedback" id="feedback">
            <div class="msg" id="feedback-msg">Click an answer. If wrong, read the clue and try again. Click Next only when you understand.</div>
            <div class="actions">
              <button class="btn" id="restart-btn" type="button">Restart</button>
              <button class="btn primary" id="next-btn" type="button" disabled>Next</button>
            </div>
          </div>

          <div class="footer-note">
            Teacher note: This practice forces re-tries. Students cannot skip with “Next” unless correct.
          </div>
        </div>
      </div>

      <!-- RIGHT: INFO PANEL -->
      <div class="card" id="vocab-panel">
        <div class="card-inner">
          <h3 class="panel-title">Quick Info</h3>

          <div class="panel-block">
            <div class="kpi"><span>Current task</span><b id="kpi-task">Vocabulary</b></div>
            <div class="kpi" style="margin-top:8px;"><span>Correct / Total</span><b id="kpi-ct">0 / 0</b></div>
            <div class="progress-wrap" aria-label="progress">
              <div class="progress-bar" id="progress-bar"></div>
            </div>
          </div>

          <div class="panel-block">
            <div class="pill">How to play</div>
            <ul class="howto">
              <li>Read the sentence/definition carefully.</li>
              <li>If wrong: read the clue, then try again.</li>
              <li>Click <b>Next</b> only when you understand.</li>
              <li>For spelling: click letters to build the word.</li>
            </ul>
          </div>

          <div class="panel-block" id="vocab-list-block">
            <div class="pill">Vocabulary list (Unit 4)</div>
            <ul class="vocab-list" id="vocab-list">
              <!-- filled by JS -->
            </ul>
          </div>

          <div class="panel-block">
            <div class="pill">Progress tips</div>
            <ul class="howto">
              <li>Use meaning clues (who/what/where/action), not first-letter clues.</li>
              <li>Look for collocations (e.g., “volcanic ash”, “sedimentary rock”).</li>
              <li>For verbs, check the action in the sentence (discover / examine / excavate).</li>
            </ul>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * DATA: Unit 4 vocab
     ***********************/
    const vocabGetReady = [
      "ash",
      "dinosaur",
      "discover",
      "examine",
      "excavate",
      "layers",
      "paleontologist",
      "pastime",
      "ravine",
      "sedimentary rock",
      "skull"
    ];
    const vocabInContext = ["determine", "dream", "favorite", "tripped"];

    // Build right-panel vocab list
    const vocabListEl = document.getElementById("vocab-list");
    [...vocabGetReady, ...vocabInContext].forEach(w=>{
      const li = document.createElement("li");
      li.textContent = w;
      vocabListEl.appendChild(li);
    });

    /***********************
     * QUESTION BANK
     * Order required by user:
     * Vocabulary – Meaning → Vocabulary – Use → Vocabulary – Spelling → Reading Comprehension
     ***********************/
    const questions = [];

    // ===== Vocabulary – Meaning (context / definition choice) =====
    const meaningItems = [
      {
        word:"paleontologist",
        question:`Which word means:\nA scientist who studies fossils and ancient life on Earth?`,
        options:["paleontologist","pastime","dinosaur","ravine"],
        answer:0,
        clue:"This is a job/science word (a person). It is about ancient life and fossils."
      },
      {
        word:"ravine",
        question:`Which word means:\nA deep, narrow valley or crack in the ground?`,
        options:["layers","ravine","ash","skull"],
        answer:1,
        clue:"This is a landform. You can climb into it, but it can be hard to climb out."
      },
      {
        word:"skull",
        question:`Which word means:\nThe bony part of the head that protects the brain?`,
        options:["skull","sedimentary rock","dinosaur","layers"],
        answer:0,
        clue:"This is part of a body. It is bone, not rock."
      },
      {
        word:"ash",
        question:`Which word means:\nSoft gray powder left after something burns (like wood)?`,
        options:["ash","layers","excavate","dream"],
        answer:0,
        clue:"Think about what is left after a fire."
      },
      {
        word:"layers",
        question:`Which word means:\nLevels stacked on top of each other (one above another)?`,
        options:["layers","favorite","discover","skull"],
        answer:0,
        clue:"Think of a cake or rock with levels."
      },
      {
        word:"sedimentary rock",
        question:`Which word means:\nA kind of rock made from small pieces that settle in layers over time?`,
        options:["sedimentary rock","ash","ravine","pastime"],
        answer:0,
        clue:"This rock is connected to layers and settling over time."
      }
    ];

    meaningItems.forEach(x => questions.push({
      type:"mc",
      section:"Vocabulary – Meaning",
      word:x.word,
      question:x.question,
      options:x.options,
      answer:x.answer,
      clue:x.clue
    }));

    // ===== Vocabulary – Use (sentence choice) =====
    const useItems = [
      {
        word:"discover",
        question:`Choose the best word:\nIn 2003, scientists __________ dinosaur bones near the village.`,
        options:["discover","layers","skull","pastime"],
        answer:0,
        clue:"They found something new for the first time."
      },
      {
        word:"examine",
        question:`Choose the best word:\nThe scientist came to the ravine and __________ the boy’s discovery carefully.`,
        options:["dream","examine","tripped","favorite"],
        answer:1,
        clue:"This verb means to look closely and study."
      },
      {
        word:"excavate",
        question:`Choose the best word:\nSoon, the team began __________ the area around the bone to find more pieces.`,
        options:["determine","discover","excavate","pastime"],
        answer:2,
        clue:"This action involves digging to uncover something."
      },
      {
        word:"determine",
        question:`Choose the best word:\nThey needed to __________ how old the bone was.`,
        options:["determine","tripped","layers","skull"],
        answer:0,
        clue:"This verb means to find out the answer using facts or tests."
      },
      {
        word:"pastime",
        question:`Choose the best word:\nFlying a kite with friends was Javier’s favorite __________.`,
        options:["pastime","ash","ravine","sedimentary rock"],
        answer:0,
        clue:"This is something you do for fun in your free time."
      },
      {
        word:"tripped",
        question:`Choose the best word:\n“I __________ on that,” Javier said, after he fell.`,
        options:["examine","tripped","discover","determine"],
        answer:1,
        clue:"This happens when your foot catches on something and you fall."
      }
    ];

    useItems.forEach(x => questions.push({
      type:"mc",
      section:"Vocabulary – Use",
      word:x.word,
      question:x.question,
      options:x.options,
      answer:x.answer,
      clue:x.clue
    }));

    // ===== Vocabulary – Spelling (Unscramble click tiles) =====
    // 5 words requested. Hide vocab panel during spelling.
    const spellingItems = [
      {
        word:"paleontologist",
        prompt:"Spelling (Unscramble): A scientist who studies fossils and ancient life.",
        clue:"Build it in chunks. It is a long job/science word."
      },
      {
        word:"sedimentary",
        prompt:"Spelling (Unscramble): A word often used before “rock” to describe rock made in layers.",
        clue:"Think: “sediment” + ending."
      },
      {
        word:"excavate",
        prompt:"Spelling (Unscramble): To dig to uncover something buried.",
        clue:"This is a verb. It is an action people do at a dig site."
      },
      {
        word:"determine",
        prompt:"Spelling (Unscramble): To find out an answer (how old / how many / what it is).",
        clue:"This is a verb often used with questions and tests."
      },
      {
        word:"ravine",
        prompt:"Spelling (Unscramble): A deep, narrow valley or cut in the ground.",
        clue:"This is a landform word. Shorter than the other spelling words."
      }
    ];

    spellingItems.forEach(x => questions.push({
      type:"spell",
      section:"Vocabulary – Spelling",
      word:x.word,
      prompt:x.prompt,
      clue:x.clue
    }));

    // ===== Reading Comprehension (2 difficult questions with passage excerpt) =====
    const rcItems = [
      {
        word:"RC1",
        question:
`Reading Comprehension (1/2)
Read the excerpt. Then answer the question.

EXCERPT:
“In 2003, paleontologists found the bones of the largest dinosaur in Europe in a wheat field near the little village. When it was alive, this animal was over 38 meters long and had the weight of seven elephants.”

QUESTION:
Why does the author include the numbers “38 meters” and “seven elephants”?`,
        options:[
          "To inform the reader how large and heavy the dinosaur was",
          "To entertain the reader with a funny joke",
          "To persuade the reader to visit the village",
          "To explain how to fly a kite"
        ],
        answer:0,
        clue:"Those details are facts. They help you understand the size."
      },
      {
        word:"RC2",
        question:
`Reading Comprehension (2/2)
Read the excerpt. Then answer the question.

EXCERPT:
“This bone was buried in sedimentary rock, which lies in layers under the ground. We’ll look for volcanic ash below and above this rock layer. Through a special process, we can find out the ages of those layers of ash. Then we’ll know that the dinosaur died sometime between those two ages.”

QUESTION:
How does volcanic ash help scientists determine the dinosaur’s age?`,
        options:[
          "They compare the ages of ash layers above and below the rock to narrow the time period",
          "They use the ash to paint the bones and make them easier to see",
          "They melt the ash to create new rock for the museum",
          "They taste the ash to see if it is old"
        ],
        answer:0,
        clue:"The excerpt says ash layers have ages. Those ages create a time range."
      }
    ];

    rcItems.forEach(x => questions.push({
      type:"mc",
      section:"Reading Comprehension",
      word:x.word,
      question:x.question,
      options:x.options,
      answer:x.answer,
      clue:x.clue
    }));

    /***********************
     * QUIZ ENGINE
     ***********************/
    let mainIndex = 0;
    let score = 0;
    let mode = "main"; // main | review
    let wrongIndices = [];
    let reviewPos = 0;
    let allowNext = false;

    // Spelling state
    let spellingState = {
      answer:"",
      built:"",
      tiles:[],
      used:[],
      attempts:0,
      q:null
    };

    const sectionTagEl = document.getElementById("section-tag");
    const qTextEl = document.getElementById("question-text");
    const optionsEl = document.getElementById("options-container");
    const feedbackEl = document.getElementById("feedback");
    const feedbackMsgEl = document.getElementById("feedback-msg");
    const nextBtn = document.getElementById("next-btn");
    const restartBtn = document.getElementById("restart-btn");

    const chipProgressEl = document.getElementById("chip-progress");
    const chipScoreEl = document.getElementById("chip-score");
    const chipModeEl = document.getElementById("chip-mode");

    const kpiTaskEl = document.getElementById("kpi-task");
    const kpiCtEl = document.getElementById("kpi-ct");
    const progressBarEl = document.getElementById("progress-bar");

    // Spelling UI refs
    const spellingArea = document.getElementById("spelling-area");
    const spellingPrompt = document.getElementById("spelling-prompt");
    const builtBox = document.getElementById("built-box");
    const tileRow = document.getElementById("tile-row");
    const clearBuiltBtn = document.getElementById("clear-built");
    const checkSpellingBtn = document.getElementById("check-spelling");
    const tryAgainBtn = document.getElementById("try-again");
    const spellingHint = document.getElementById("spelling-hint");
    const vocabPanel = document.getElementById("vocab-panel");

    function currentQuestionIndex(){
      if(mode === "main") return mainIndex;
      return wrongIndices[reviewPos];
    }

    function updateRightPanel(){
      const total = questions.length;
      const pos = (mode === "main") ? (mainIndex+1) : (reviewPos+1);
      chipProgressEl.textContent = `${pos}/${(mode==="main") ? total : wrongIndices.length}`;
      chipScoreEl.textContent = score;
      chipModeEl.textContent = (mode === "main") ? "Main" : "Review";

      const q = questions[currentQuestionIndex()];
      kpiTaskEl.textContent = q.section.includes("Reading") ? "Reading" : "Vocabulary";
      const denom = (mode === "main") ? total : wrongIndices.length;
      kpiCtEl.textContent = `${score} / ${total}`;
      const pct = (mode === "main") ? Math.round((mainIndex)/total * 100) : Math.round((reviewPos)/Math.max(1,wrongIndices.length) * 100);
      progressBarEl.style.width = `${pct}%`;
    }

    function setFeedback(type, msg){
      feedbackEl.classList.remove("good","bad");
      if(type === "good") feedbackEl.classList.add("good");
      if(type === "bad") feedbackEl.classList.add("bad");
      feedbackMsgEl.innerHTML = msg;
    }

    function lockNext(){
      allowNext = false;
      nextBtn.disabled = true;
    }
    function unlockNext(){
      allowNext = true;
      nextBtn.disabled = false;
    }

    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function getContextHint(q, attempts){
      // NOT first-letter clues. Focus on meaning, word type, collocation, and story logic.
      const base = [
        "Use the sentence: what is happening (action)? who is involved (person)? where (place)?",
        "Check the word type: is it a person/job, an object, a place, or an action verb?",
        "Look for strong collocations from the story (e.g., volcanic ash / sedimentary rock / dig to uncover).",
        "Re-read and underline the key idea. Which option matches that meaning best?",
        "If it is a verb, ask: what did they DO? If it is a noun, ask: what THING is it?"
      ];
      let extra = q.clue ? `<br><b>Clue:</b> ${q.clue}` : "";
      if(attempts >= 2){
        return base[2] + extra;
      }
      return base[Math.floor(Math.random()*base.length)] + extra;
    }

    function showQuestion(){
      const idx = currentQuestionIndex();
      const q = questions[idx];

      // Reset UI
      optionsEl.innerHTML = "";
      optionsEl.style.display = "";
      spellingArea.style.display = "none";
      spellingHint.style.display = "none";
      tryAgainBtn.style.display = "none";
      builtBox.textContent = "";
      tileRow.innerHTML = "";
      feedbackEl.classList.remove("good","bad");

      lockNext();
      setFeedback("", "Click an answer. If wrong, read the clue and try again. Click Next only when you understand.");

      sectionTagEl.textContent = q.section;
      qTextEl.textContent = q.question || "";

      // Hide vocab panel ONLY during spelling
      if(q.type === "spell"){
        vocabPanel.style.display = "none";
        optionsEl.style.display = "none";
        renderSpelling(q);
      } else {
        vocabPanel.style.display = "";
        renderMC(q);
      }

      updateRightPanel();
    }

    function renderMC(q){
      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "opt-btn";
        btn.type = "button";
        btn.textContent = opt;
        btn.addEventListener("click", () => handleMCAnswer(i));
        optionsEl.appendChild(btn);
      });
    }

    function disableMC(){
      const btns = optionsEl.querySelectorAll("button");
      btns.forEach(b => b.disabled = true);
    }

    function handleMCAnswer(selected){
      const idx = currentQuestionIndex();
      const q = questions[idx];

      // Enforce try again (do not let them skip after wrong)
      if(selected === q.answer){
        disableMC();
        // Only score in main mode first pass
        if(mode === "main") score++;
        setFeedback("good", "Correct. Click Next when you are ready.");
        unlockNext();
      } else {
        // Keep options enabled so they can try again; no Next.
        if(mode === "main" && !wrongIndices.includes(idx)){
          wrongIndices.push(idx);
        }
        setFeedback("bad", `Try again.<br>${getContextHint(q, 1)}`);
        lockNext();
      }

      updateRightPanel();
    }

    // ===== Spelling (click tiles) =====
    function renderSpelling(q){
      spellingState.q = q;
      spellingState.answer = (q.word || "").toLowerCase().trim().replace(/\s+/g,"");
      spellingState.built = "";
      spellingState.attempts = 0;

      const letters = spellingState.answer.split("");
      spellingState.tiles = shuffleArray(letters);
      spellingState.used = new Array(spellingState.tiles.length).fill(false);

      spellingArea.style.display = "block";
      spellingPrompt.textContent = q.prompt || "Unscramble the word.";

      drawTiles();

      spellingHint.style.display = "none";
      tryAgainBtn.style.display = "none";

      // Feedback area stays; Next locked until correct
      lockNext();
      setFeedback("", "Spelling: click the letter tiles to build the word. Click Check when finished.");
    }

    function drawTiles(){
      tileRow.innerHTML = "";
      spellingState.tiles.forEach((ch, idx) => {
        const b = document.createElement("button");
        b.className = "tile-btn";
        b.type = "button";
        b.textContent = ch.toUpperCase();
        b.disabled = spellingState.used[idx];
        b.addEventListener("click", () => {
          spellingState.used[idx] = true;
          spellingState.built += ch;
          builtBox.textContent = spellingState.built.toUpperCase();
          drawTiles();
        });
        tileRow.appendChild(b);
      });
    }

    function spellingHintText(attempts){
      const q = spellingState.q;
      const base = [
        "Use the meaning: is it an action, a place, or a science/job word?",
        "Try building in chunks (beginning + middle + ending), not letter by letter.",
        "Say the word slowly. Do you hear parts you can group together?",
        "For long words: build the ending first, then fill the middle."
      ];
      const extra = q.clue ? ` Extra clue: ${q.clue}` : "";
      if(attempts >= 2){
        return `Hint: the word has ${spellingState.answer.length} letters. Try the ending first.${extra}`;
      }
      return base[Math.floor(Math.random()*base.length)] + extra;
    }

    clearBuiltBtn.addEventListener("click", () => {
      spellingState.built = "";
      spellingState.used = spellingState.used.map(()=>false);
      builtBox.textContent = "";
      spellingHint.style.display = "none";
      tryAgainBtn.style.display = "none";
      drawTiles();
    });

    checkSpellingBtn.addEventListener("click", () => {
      const attempt = (spellingState.built || "").toLowerCase().trim();
      const answer = spellingState.answer;

      if(attempt.length !== answer.length){
        spellingHint.style.display = "block";
        spellingHint.textContent = "Use all the letter tiles before you check.";
        return;
      }

      if(attempt === answer){
        // Correct
        if(mode === "main") score++;
        setFeedback("good", "Correct spelling. Click Next when you are ready.");
        spellingHint.style.display = "none";
        tryAgainBtn.style.display = "none";
        unlockNext();
        updateRightPanel();
      } else {
        // Wrong → try again + meaning-based hint
        const idx = currentQuestionIndex();
        if(mode === "main" && !wrongIndices.includes(idx)){
          wrongIndices.push(idx);
        }

        spellingState.attempts++;
        spellingHint.style.display = "block";
        spellingHint.textContent = "Try again. " + spellingHintText(spellingState.attempts);

        tryAgainBtn.style.display = "inline-block";
        lockNext();
        updateRightPanel();
      }
    });

    tryAgainBtn.addEventListener("click", () => {
      // Easier retry: clear and reshuffle
      spellingState.built = "";
      spellingState.used = spellingState.used.map(()=>false);
      spellingState.tiles = shuffleArray(spellingState.tiles);
      builtBox.textContent = "";
      drawTiles();
    });

    // ===== Next logic (main → review) =====
    nextBtn.addEventListener("click", () => {
      if(!allowNext) return;

      if(mode === "main"){
        mainIndex++;
        if(mainIndex < questions.length){
          showQuestion();
        } else {
          startReviewOrFinish();
        }
      } else {
        reviewPos++;
        if(reviewPos < wrongIndices.length){
          showQuestion();
        } else {
          finish();
        }
      }
    });

    function startReviewOrFinish(){
      if(wrongIndices.length > 0){
        mode = "review";
        reviewPos = 0;
        // In review we do NOT change score (you already earned score only in main),
        // but we still require correct to proceed.
        setFeedback("", "Review mode: redo the questions you missed. Click Next only after you get it correct.");
        showQuestion();
      } else {
        finish();
      }
    }

    function finish(){
      // Show a simple results screen in the left card
      vocabPanel.style.display = "";

      sectionTagEl.textContent = "All Done";
      qTextEl.textContent = "You have finished the practice.";

      optionsEl.innerHTML = "";
      spellingArea.style.display = "none";
      unlockNext();
      nextBtn.disabled = true;

      // List words to review (unique)
      const wrongWords = wrongIndices.map(i => questions[i].word).filter(Boolean);
      const unique = [...new Set(wrongWords)];

      if(unique.length){
        setFeedback("bad",
          `Finished.<br><b>Final score:</b> ${score} / ${questions.length}<br><br>` +
          `<b>Review these words:</b><br>• ${unique.join("<br>• ")}`
        );
      } else {
        setFeedback("good", `Finished.<br><b>Final score:</b> ${score} / ${questions.length}<br><br>Excellent accuracy.`);
      }

      chipModeEl.textContent = "Done";
      chipProgressEl.textContent = `${questions.length}/${questions.length}`;
      progressBarEl.style.width = "100%";
      kpiCtEl.textContent = `${score} / ${questions.length}`;
    }

    // Restart
    restartBtn.addEventListener("click", () => {
      mainIndex = 0;
      score = 0;
      mode = "main";
      wrongIndices = [];
      reviewPos = 0;
      allowNext = false;

      // Restore panel (in case hidden)
      vocabPanel.style.display = "";

      showQuestion();
    });

    // Init
    // Update chip total label with real length
    chipProgressEl.textContent = `1/${questions.length}`;
    kpiCtEl.textContent = `0 / ${questions.length}`;
    showQuestion();
  </script>
</body>
</html>


