<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit 4 – Stumbling upon the Past (Vocabulary Practice)</title>
  <style>
    :root{
      --bg1:#07101f;
      --bg2:#0b1b33;
      --panel:rgba(255,255,255,0.06);
      --stroke:rgba(255,255,255,0.10);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.72);
      --good:#28c76f;
      --bad:#ff4d4f;
      --accent:#77a7ff;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius:26px;
      --font: "Century Gothic", "Trebuchet MS", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(119,167,255,0.18), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,204,102,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }

    .rotate-banner{
      position: sticky;
      top: 0;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      margin: 0 0 10px 0;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(6, 10, 20, 0.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.92);
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }
    .rb-left{ display:flex; align-items:center; gap:12px; min-width:0; }
    .rb-icons{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    .phone-icon{
      width: 26px; height: 26px;
      fill: none;
      stroke: rgba(255,255,255,0.85);
      stroke-width: 3;
    }
    .phone-icon circle{ fill: rgba(255,255,255,0.85); stroke: none; }
    .rb-arrow{ opacity: 0.85; font-size: 16px; }
    .rb-text{
      font-size: 13px;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .rb-close{
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }
    @media (max-width: 720px){
      .rotate-banner{ display:flex; }
    }

    .app{
      width:min(1220px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:18px 18px;
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .header:before{
      content:"";
      position:absolute;
      inset:-80px -120px auto auto;
      width:340px;
      height:340px;
      background: radial-gradient(circle at 30% 30%, rgba(119,167,255,0.30), transparent 60%);
      opacity:0.9;
      transform: rotate(10deg);
      pointer-events:none;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
    }
    .logoWrap{
      width:56px;
      height:56px;
      border-radius:16px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoWrap img{
      width:80%;
      height:80%;
      object-fit:contain;
      display:block;
    }
    .titleBlock{ min-width:0; }
    .title{
      font-size:34px;
      line-height:1.1;
      margin:0;
      letter-spacing:0.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badges{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width: 260px;
    }
    .badge{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
    }
    .badge strong{ color:var(--text); font-weight:700; }
    .badge .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,0.35);
    }

    .pbBadge{
      width: 100%;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      gap:12px;
    }
    .pbText{
      font-size: 13px;
      color: rgba(255,255,255,0.80);
      min-width: 92px;
      white-space: nowrap;
    }
    .pbTrack{
      flex: 1 1 auto;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .pbFill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(119,167,255,0.55), rgba(119,167,255,0.25));
      border-right: 1px solid rgba(255,255,255,0.18);
      transition: width 180ms ease;
    }

    .layout{
      display:grid;
      grid-template-columns: 1.55fr 0.85fr;
      gap:14px;
      align-items:start;
    }

    .card{
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardInner{ padding:22px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--muted);
      font-size:14px;
    }
    .pill strong{ color:var(--text); }

    .qTitle{
      margin:16px 0 8px 0;
      font-size:34px;
      line-height:1.08;
      letter-spacing:0.2px;
    }
    .qPrompt{
      margin:0 0 16px 0;
      color:var(--muted);
      font-size:16px;
      line-height:1.55;
      white-space:pre-line;
    }

    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }

    .optBtn{
      width:100%;
      text-align:left;
      padding:16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color:var(--text);
      cursor:pointer;
      font-size:16px;
      line-height:1.25;
      transition: transform .08s ease, box-shadow .08s ease, background .08s ease;
      min-height:54px;
    }
    .optBtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.07);
      box-shadow: 0 10px 26px rgba(0,0,0,0.25);
    }
    .optBtn:disabled{
      opacity:0.6;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .hintBox{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding:14px 14px;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      min-height:54px;
    }
    .hintBox strong{ color:var(--text); }

    .feedback{
      margin-top:12px;
      font-size:15px;
      line-height:1.45;
      min-height:24px;
    }
    .feedback.good{ color: var(--good); }
    .feedback.bad{ color: var(--bad); }

    .actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:12px 16px;
      font-size:15px;
      font-family:var(--font);
      color:var(--text);
      background: rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.12);
      transition: background .08s ease, transform .08s ease;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(119,167,255,0.30), rgba(119,167,255,0.18));
      border:1px solid rgba(119,167,255,0.38);
    }
    .btn.primary:hover{ background: linear-gradient(180deg, rgba(119,167,255,0.36), rgba(119,167,255,0.22)); }

    .smallLink{
      background:none;
      border:none;
      color:rgba(255,255,255,0.65);
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      text-decoration:underline;
    }
    .smallLink:hover{ color:rgba(255,255,255,0.85); background: rgba(255,255,255,0.05); }

    .sideTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sideTitle{
      margin:0;
      font-size:16px;
      letter-spacing:0.2px;
      color:rgba(255,255,255,0.85);
    }
    .tag{
      font-size:12px;
      color:rgba(255,255,255,0.75);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      white-space:nowrap;
    }

    .sideBlock{
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding:14px;
      margin-top:12px;
    }
    .sideBlock h4{
      margin:0 0 8px 0;
      font-size:13px;
      color:rgba(255,255,255,0.80);
      letter-spacing:0.2px;
    }
    .sideBlock ul{
      margin:0;
      padding-left:18px;
      color:rgba(255,255,255,0.72);
      font-size:13px;
      line-height:1.5;
    }
    .vocabList{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color:rgba(255,255,255,0.78);
      font-size:13px;
    }
    .hiddenNote{
      color:rgba(255,255,255,0.60);
      font-size:13px;
      line-height:1.45;
    }

    .spellBox{
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding:16px;
      margin-top:14px;
    }
    .spellTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .timerArea{
      min-width: 220px;
      flex: 0 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .timerPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      color:rgba(255,255,255,0.80);
      font-size:14px;
      white-space:nowrap;
    }
    .timerPill strong{ color:rgba(255,255,255,0.95); }
    .timerWarn{ border-color: rgba(255,77,79,0.35); background: rgba(255,77,79,0.10); }

    /* Countdown bar */
    .countdownTrack{
      width: 220px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .countdownFill{
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, rgba(119,167,255,0.55), rgba(119,167,255,0.22));
      transition: width 120ms linear;
    }
    .countdownWarn{
      background: linear-gradient(90deg, rgba(255,77,79,0.55), rgba(255,77,79,0.18));
    }

    .spellAnswerRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .blanks{
      font-size:26px;
      letter-spacing:4px;
      color:rgba(255,255,255,0.92);
      line-height:1.2;
      word-break:break-word;
    }
    .letterBank{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .letterBtn{
      min-width:44px;
      height:44px;
      padding:0 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color:rgba(255,255,255,0.90);
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition: transform .08s ease, background .08s ease, box-shadow .08s ease;
    }
    .letterBtn:hover{ background: rgba(255,255,255,0.08); transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,0.25); }
    .letterBtn:disabled{ opacity:0.35; cursor:default; transform:none; box-shadow:none; }

    .spellTools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .excerpt{
      margin-top:10px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.80);
      font-size:14px;
      line-height:1.55;
      white-space:pre-line;
    }

    .endBox{
      padding:18px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      margin-top:14px;
      color: rgba(255,255,255,0.80);
      line-height:1.6;
    }
    .endBox ul{ margin:10px 0 0 0; padding-left:18px; }
    .endBox strong{ color: rgba(255,255,255,0.95); }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .badges{ justify-content:flex-start; min-width: unset; width: 100%; }
      .title{ font-size:28px; }
      .pbBadge{ width: 100%; }
      .timerArea{ align-items:flex-start; }
    }
    @media (max-width: 720px){
      body{ padding:12px; }
      .header{ padding:14px; border-radius:22px; flex-direction: column; align-items:flex-start; }
      .logoWrap{ width:48px; height:48px; border-radius:14px; }
      .title{ font-size:24px; }
      .subtitle{ font-size:13px; white-space: normal; }
      .cardInner{ padding:16px; }
      .qTitle{ font-size:26px; }
      .options{ grid-template-columns: 1fr; }
      .optBtn{ font-size:16px; padding:16px; }
      .badge{ padding:9px 12px; font-size:13px; }
      .blanks{ font-size:22px; letter-spacing:3px; }
      .letterBtn{ min-width:46px; height:46px; border-radius:16px; font-size:18px; }
      .timerArea{ width:100%; }
      .countdownTrack{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div id="rotateBanner" class="rotate-banner" role="note" aria-label="Rotate phone reminder">
      <div class="rb-left">
        <div class="rb-icons" aria-hidden="true">
          <svg class="phone-icon" viewBox="0 0 64 64">
            <rect x="18" y="6" width="28" height="52" rx="5" ry="5"></rect>
            <circle cx="32" cy="50" r="2.4"></circle>
          </svg>
          <span class="rb-arrow">→</span>
          <svg class="phone-icon" viewBox="0 0 64 64">
            <rect x="6" y="18" width="52" height="28" rx="5" ry="5"></rect>
            <circle cx="50" cy="32" r="2.4"></circle>
          </svg>
        </div>
        <div class="rb-text"><strong>On a phone?</strong> Turn your device sideways for the best view.</div>
      </div>
      <button class="rb-close" id="closeRotateBanner" aria-label="Close">✕</button>
    </div>

    <div class="header">
      <div class="brand">
        <div class="logoWrap" title="Logo">
          <img src="logo.png" alt="GA Logo" onerror="this.style.display='none';" />
        </div>
        <div class="titleBlock">
          <h1 class="title">Unit 4 – Stumbling upon the Past</h1>
          <p class="subtitle">Vocabulary – Meaning • Use • Spelling (click to build) • Reading Comprehension</p>
        </div>
      </div>

      <div class="badges">
        <div class="badge"><span class="dot"></span> Correct: <strong id="scoreText">0</strong></div>

        <div class="pbBadge" aria-label="Progress bar">
          <div class="pbText"><strong id="progressText">1/25</strong></div>
          <div class="pbTrack" role="progressbar" aria-valuemin="0" aria-valuemax="25" aria-valuenow="1">
            <div class="pbFill" id="pbFill"></div>
          </div>
        </div>

        <div class="badge"><span class="dot"></span> Mode: <strong id="modeText">Main</strong></div>
      </div>
    </div>

    <div class="layout">

      <div class="card">
        <div class="cardInner">

          <div class="pill" id="sectionPill"><strong>Vocabulary – Meaning</strong> <span id="sectionSub">• choose the best meaning</span></div>

          <div class="qTitle" id="qTitle">Question</div>
          <div class="qPrompt" id="qPrompt"></div>

          <div class="excerpt" id="excerptBox" style="display:none;"></div>

          <div class="options" id="options"></div>

          <div class="spellBox" id="spellBox" style="display:none;">
            <div class="spellTopRow">
              <div class="qPrompt" style="margin:0; color:rgba(255,255,255,0.78);">
                <strong>Build the word by clicking letters.</strong> (Click on the letters.)
              </div>

              <div class="timerArea">
                <div class="timerPill" id="timerPill">Time left: <strong id="timerText">15</strong>s</div>
                <div class="countdownTrack" aria-label="Countdown bar">
                  <div class="countdownFill" id="countdownFill"></div>
                </div>
              </div>
            </div>

            <div class="spellAnswerRow">
              <div>
                <div class="blanks" id="spellBlanks"></div>
              </div>
              <div style="flex:1 1 260px; text-align:right;">
                <div class="hintBox" id="spellHint" style="min-height:auto;">
                  <strong>Hint:</strong> Use the clue sentence. If you’re stuck, click <strong>Clue</strong> to reveal one letter.
                </div>
              </div>
            </div>

            <div class="letterBank" id="letterBank"></div>

            <div class="spellTools">
              <button class="btn" id="backspaceBtn">Backspace</button>
              <button class="btn" id="clearBtn">Clear</button>
              <button class="btn" id="clueBtn">Clue</button>
              <button class="btn primary" id="submitSpellBtn">Check</button>
            </div>

            <div class="feedback" id="spellFeedback"></div>
          </div>

          <div class="feedback" id="feedback"></div>

          <div class="hintBox" id="hintBox"><strong>Hint:</strong> Click <strong>Show hint</strong> if you need help using the context.</div>

          <div class="actions">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="nextBtn" disabled>Next</button>
              <button class="btn" id="hintBtn">Show hint</button>
            </div>

            <button class="smallLink" id="resetLink" title="Reset the activity">Reset (teacher)</button>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="sideTop">
            <h3 class="sideTitle">Vocabulary + Instructions + Progress Tips</h3>
            <div class="tag" id="currentTaskTag">Vocabulary</div>
          </div>

          <div class="sideBlock">
            <h4>How to play</h4>
            <ul>
              <li>Click an answer.</li>
              <li>If wrong: read the hint and try again.</li>
              <li>Click <strong>Next</strong> only when you understand.</li>
            </ul>
          </div>

          <div class="sideBlock" id="vocabBlock">
            <h4>Vocabulary list (Unit 4)</h4>
            <div class="vocabList" id="vocabChips"></div>
            <div class="hiddenNote" id="vocabHiddenNote" style="display:none; margin-top:10px;">
              Vocabulary list is hidden during <strong>Spelling</strong> so students must rely on memory + clues.
            </div>
          </div>

          <div class="sideBlock">
            <h4>Progress tip</h4>
            <ul>
              <li>For “Use” questions: choose the word that fits the meaning AND the grammar.</li>
              <li>For “Meaning” questions: match the definition to the vocabulary word.</li>
              <li>For “Spelling”: click letters carefully, then check.</li>
              <li>For reading questions: re-read the excerpt and answer using evidence.</li>
            </ul>
          </div>

          <div class="sideBlock">
            <h4>Teacher note</h4>
            <ul>
              <li>Reset is a teacher link to prevent accidental clicks.</li>
              <li>At the end, students review any questions they missed.</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
const VOCAB = [
  "ash","dinosaur","discover","examine","excavate","layers","paleontologist","pastime",
  "ravine","sedimentary rock","skull","determine","dream","favorite","tripped"
];

// 10 Meaning
const meaningQuestions = [
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nA scientist who studies fossils and ancient life on Earth?",
    options:["paleontologist","pastime","skull","layers"], answer:0,
    hint:"This person studies fossils, bones, and life from long ago."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nA deep, narrow valley or gap in the ground?",
    options:["ravine","layers","ash","favorite"], answer:0,
    hint:"It’s a landform—often steep and difficult to climb out of."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which phrase means:\nRock formed over time from small pieces pressed into layers?",
    options:["sedimentary rock","ash","skull","pastime"], answer:0,
    hint:"This kind of rock often forms in layers (like a stack)."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nTo dig carefully to uncover something buried?",
    options:["excavate","discover","dream","examine"], answer:0,
    hint:"Scientists do this to uncover bones or objects underground."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nTo look at something closely and carefully to learn about it?",
    options:["examine","tripped","favorite","layers"], answer:0,
    hint:"You do this when you want details and evidence."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nLevels stacked on top of each other, like sheets or parts of a cake?",
    options:["layers","skull","ash","dream"], answer:0,
    hint:"Think: one level on top of another."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nTo find out the answer by checking facts or evidence?",
    options:["determine","discover","favorite","pastime"], answer:0,
    hint:"Scientists do this using tests and clues."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nYour foot caught on something and you almost fell (or fell)?",
    options:["tripped","dream","discover","skull"], answer:0,
    hint:"It’s a movement accident when walking or running."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nAn activity you do for fun in your free time?",
    options:["pastime","layers","ash","examine"], answer:0,
    hint:"It’s not work—it's a hobby or fun activity."
  },
  { type:"mcq", section:"Vocabulary – Meaning",
    prompt:"Which word means:\nThe hard bone that protects the brain in your head?",
    options:["skull","ash","ravine","favorite"], answer:0,
    hint:"It’s part of the skeleton—your head bone."
  }
];

// 8 Use
const useQuestions = [
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nIn 2003, paleontologists __________ the bones in a field near the village.",
    options:["discovered","layers","pastime","dream"], answer:0,
    hint:"This verb means they found something that was already there."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nJavier ran down into the ravine and __________ on something on the ground.",
    options:["tripped","determined","excavated","examined"], answer:0,
    hint:"What happens when your foot catches and you lose balance?"
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nThe paleontologist came to the town and __________ the boy’s discovery carefully.",
    options:["examined","dreamed","layered","favored"], answer:0,
    hint:"This means she looked closely to learn details."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nSedimentary rock lies in __________ under the ground.",
    options:["layers","ash","skulls","pastimes"], answer:0,
    hint:"This refers to levels stacked one on top of another."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nAfter a volcano erupts, you may find volcanic __________ in the air and on the ground.",
    options:["ash","ravine","favorite","skull"], answer:0,
    hint:"It’s fine gray material left after something burns."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nScientists can test the rock to __________ how old it is.",
    options:["determine","discover","trip","pastime"], answer:0,
    hint:"This means ‘find out’ using evidence."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nSoon, the team began __________ the area around the bone to find more pieces.",
    options:["excavating","dreaming","layering","favoriting"], answer:0,
    hint:"This action means digging carefully to uncover something buried."
  },
  { type:"mcq", section:"Vocabulary – Use",
    prompt:"Choose the best word:\nA __________ studies fossils to learn about ancient life on Earth.",
    options:["paleontologist","pastime","ravine","ash"], answer:0,
    hint:"This is a scientist, not a place or a thing."
  }
];

// 5 Spelling (timed, click letters)
const spellingQuestions = [
  { type:"spell", section:"Vocabulary – Spelling", word:"paleontologist",
    prompt:"Spelling:\nA scientist who studies fossils and ancient life on Earth.",
    hint:"Think: a job title for fossil scientists."
  },
  { type:"spell", section:"Vocabulary – Spelling", word:"sedimentary",
    prompt:"Spelling:\nA word that describes rock formed in layers over time.",
    hint:"It relates to ‘sediment’ and layers."
  },
  { type:"spell", section:"Vocabulary – Spelling", word:"excavate",
    prompt:"Spelling:\nTo dig carefully to uncover something buried.",
    hint:"Scientists do this at a dig site."
  },
  { type:"spell", section:"Vocabulary – Spelling", word:"ravine",
    prompt:"Spelling:\nA deep, narrow valley or gap in the ground.",
    hint:"A landform you might climb down into."
  },
  { type:"spell", section:"Vocabulary – Spelling", word:"determine",
    prompt:"Spelling:\nTo find out the answer using evidence.",
    hint:"Scientists do this with tests and facts."
  }
];

// 2 Reading comprehension
const readingExcerpt = [
  '“This bone was buried in sedimentary rock, which lies in layers under the ground.”',
  '“Soon, many paleontologists began excavating the area around the bone.”'
];
const readingQuestions = [
  { type:"mcq", section:"Reading Comprehension",
    excerpt: readingExcerpt.join("\\n\\n"),
    prompt:"Based on the excerpt, why do ‘layers’ matter for the scientists?",
    options:[
      "They can use layers to help figure out information like age and what happened over time.",
      "Layers are only important because they make rocks look pretty.",
      "Layers mean the bone must be on the surface, not buried.",
      "Layers are the same as ash and do not give useful information."
    ],
    answer:0,
    hint:"Think like a scientist: layers are evidence over time."
  },
  { type:"mcq", section:"Reading Comprehension",
    excerpt: readingExcerpt.join("\\n\\n"),
    prompt:"What does the word ‘excavating’ show about how the scientists work?",
    options:[
      "They dig carefully and slowly to uncover more evidence without damaging it.",
      "They run quickly and kick dirt away because speed is most important.",
      "They stop working and only talk to reporters.",
      "They paint the bones to make them easier to see."
    ],
    answer:0,
    hint:"Excavating is careful digging to uncover buried evidence."
  }
];

const QUESTIONS = [...meaningQuestions, ...useQuestions, ...spellingQuestions, ...readingQuestions];

/* STATE */
let order = [...Array(QUESTIONS.length).keys()];
let idx = 0;
let correctCount = 0;
let mode = "Main";
let missed = [];
let attempts = 0;
let answeredCorrect = false;

/* Spelling state */
let spellTarget = "";
let revealed = [];
let buildStack = [];
let bankItems = [];
let activeSpell = false;

let spellTimer = null;
let timeLeft = 15;
const SPELL_SECONDS = 15;

/* ELEMENTS */
const progressText = document.getElementById("progressText");
const pbFill = document.getElementById("pbFill");
const pbTrack = document.querySelector(".pbTrack[role='progressbar']");
const scoreText = document.getElementById("scoreText");
const modeText = document.getElementById("modeText");

const sectionPill = document.getElementById("sectionPill");
const qTitle = document.getElementById("qTitle");
const qPrompt = document.getElementById("qPrompt");
const optionsEl = document.getElementById("options");
const feedbackEl = document.getElementById("feedback");
const hintBox = document.getElementById("hintBox");

const excerptBox = document.getElementById("excerptBox");

const nextBtn = document.getElementById("nextBtn");
const hintBtn = document.getElementById("hintBtn");
const resetLink = document.getElementById("resetLink");
const currentTaskTag = document.getElementById("currentTaskTag");

const vocabChips = document.getElementById("vocabChips");
const vocabHiddenNote = document.getElementById("vocabHiddenNote");

// Spelling UI
const spellBox = document.getElementById("spellBox");
const spellBlanks = document.getElementById("spellBlanks");
const letterBankEl = document.getElementById("letterBank");
const backspaceBtn = document.getElementById("backspaceBtn");
const clearBtn = document.getElementById("clearBtn");
const clueBtn = document.getElementById("clueBtn");
const submitSpellBtn = document.getElementById("submitSpellBtn");
const spellFeedback = document.getElementById("spellFeedback");
const spellHint = document.getElementById("spellHint");
const timerText = document.getElementById("timerText");
const timerPill = document.getElementById("timerPill");
const countdownFill = document.getElementById("countdownFill");

/* ROTATE BANNER */
(function(){
  const banner = document.getElementById('rotateBanner');
  const closeBtn = document.getElementById('closeRotateBanner');
  if(!banner || !closeBtn) return;
  if(localStorage.getItem('hideRotateBanner') === '1'){
    banner.style.display = 'none';
    return;
  }
  closeBtn.addEventListener('click', () => {
    banner.style.display = 'none';
    localStorage.setItem('hideRotateBanner', '1');
  });
})();

/* HELPERS */
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function setHeader(){
  modeText.textContent = mode;
  scoreText.textContent = correctCount;

  const total = (mode === "Main") ? QUESTIONS.length : missed.length;
  const pos = idx + 1;
  progressText.textContent = `${pos}/${total}`;

  const pct = Math.round((pos / total) * 100);
  pbFill.style.width = `${pct}%`;
  if(pbTrack) pbTrack.setAttribute("aria-valuenow", String(pos));
}

function sectionLabel(section){
  if(section.includes("Meaning")) return "Vocabulary";
  if(section.includes("Use")) return "Vocabulary";
  if(section.includes("Spelling")) return "Vocabulary";
  if(section.includes("Reading")) return "Reading";
  return "Practice";
}

function clearMCQUI(){
  optionsEl.innerHTML = "";
  feedbackEl.textContent = "";
  feedbackEl.className = "feedback";
  hintBox.innerHTML = "<strong>Hint:</strong> Click <strong>Show hint</strong> if you need help using the context.";
  nextBtn.disabled = true;
}

function buildContextHint(q){
  if(q.section.includes("Use")){
    return "Underline the blank mentally. Do you need an action (verb) or a thing (noun)? Choose the word that fits both meaning and grammar.";
  }
  if(q.section.includes("Meaning")){
    return "Ask: Is the definition a person, place, thing, or action? Eliminate options that don’t match that category.";
  }
  if(q.section.includes("Reading")){
    return "Use evidence from the excerpt. Choose the answer that matches what the text suggests—avoid answers that add new ideas.";
  }
  return q.hint || "Use the context of the sentence to choose the best answer.";
}

function renderVocabChips(){
  vocabChips.innerHTML = "";
  VOCAB.forEach(w=>{
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = w;
    vocabChips.appendChild(chip);
  });
}

function getCurrentQuestion(){
  const qIndex = (mode === "Main") ? order[idx] : missed[idx];
  return { q: QUESTIONS[qIndex], qIndex };
}

function setRightPanelVisibilityForSection(section){
  const hide = section.includes("Spelling");
  vocabChips.style.display = hide ? "none" : "flex";
  vocabHiddenNote.style.display = hide ? "block" : "none";
}

/* TIMER */
function stopSpellTimer(){
  if(spellTimer){
    clearInterval(spellTimer);
    spellTimer = null;
  }
}

function updateCountdownUI(){
  timerText.textContent = String(Math.max(0, timeLeft));
  const pct = Math.max(0, Math.min(1, timeLeft / SPELL_SECONDS));
  countdownFill.style.width = (pct * 100).toFixed(1) + "%";

  timerPill.classList.toggle("timerWarn", timeLeft <= 5);
  countdownFill.classList.toggle("countdownWarn", timeLeft <= 5);
}

function startSpellTimer(seconds=SPELL_SECONDS){
  stopSpellTimer();
  timeLeft = seconds;
  updateCountdownUI();

  spellTimer = setInterval(() => {
    if(!activeSpell){
      stopSpellTimer();
      return;
    }
    timeLeft -= 1;
    updateCountdownUI();

    if(timeLeft <= 0){
      stopSpellTimer();
      timeUpRevealAnswer();
    }
  }, 1000);
}

function timeUpRevealAnswer(){
  if(mode === "Main"){
    const qIndex = order[idx];
    if(!missed.includes(qIndex)) missed.push(qIndex);
  }

  buildStack = [];
  const letters = spellTarget.split("");
  for(let i=0;i<letters.length;i++){
    buildStack.push({ id: "auto_"+i, ch: letters[i], from:"auto" });
  }
  revealed = new Array(letters.length).fill(true);
  renderSpellingBlanks();
  renderLetterBank();

  spellFeedback.textContent = "Time is up. The correct answer is shown. Click Next to continue.";
  spellFeedback.className = "feedback bad";
  nextBtn.disabled = false;

  setSpellControlsEnabled(false);
  activeSpell = false;

  timeLeft = 0;
  updateCountdownUI();
}

/* RENDER MAIN */
function render(){
  stopSpellTimer();
  activeSpell = false;

  setHeader();
  const { q } = getCurrentQuestion();
  attempts = 0;
  answeredCorrect = false;

  currentTaskTag.textContent = sectionLabel(q.section);

  sectionPill.innerHTML = `<strong>${q.section}</strong> <span>• ${q.type === "spell" ? "click letters to spell" : "choose the best answer"}</span>`;
  qTitle.textContent = (mode === "Main")
    ? `Question ${idx+1} of ${QUESTIONS.length}`
    : `Review ${idx+1} of ${missed.length}`;

  qPrompt.textContent = q.prompt;

  if(q.section.includes("Reading")){
    excerptBox.style.display = "block";
    excerptBox.textContent = q.excerpt;
  }else{
    excerptBox.style.display = "none";
    excerptBox.textContent = "";
  }

  setRightPanelVisibilityForSection(q.section);
  clearMCQUI();

  if(q.type === "spell"){
    optionsEl.style.display = "none";
    hintBox.style.display = "none";
    feedbackEl.style.display = "none";
    spellBox.style.display = "block";
    initSpelling(q);
  }else{
    spellBox.style.display = "none";
    optionsEl.style.display = "grid";
    hintBox.style.display = "block";
    feedbackEl.style.display = "block";
    renderOptions(q);
  }

  nextBtn.disabled = true;
}

/* MCQ */
function renderOptions(q){
  optionsEl.innerHTML = "";
  q.options.forEach((opt, i)=>{
    const b = document.createElement("button");
    b.className = "optBtn";
    b.textContent = opt;
    b.addEventListener("click", ()=> handleMCQAnswer(i, q));
    optionsEl.appendChild(b);
  });
}

function disableAllOptions(disabled=true){
  const btns = optionsEl.querySelectorAll("button");
  btns.forEach(b => b.disabled = disabled);
}

function handleMCQAnswer(choiceIndex, q){
  if(answeredCorrect) return;
  attempts += 1;

  if(choiceIndex === q.answer){
    answeredCorrect = true;
    if(mode === "Main") correctCount += 1;

    feedbackEl.textContent = "Correct.";
    feedbackEl.className = "feedback good";
    disableAllOptions(true);
    nextBtn.disabled = false;
  }else{
    feedbackEl.textContent = "Not yet. Read the hint and try again.";
    feedbackEl.className = "feedback bad";
    hintBox.innerHTML = `<strong>Hint:</strong> ${buildContextHint(q)}`;

    if(mode === "Main"){
      const qIndex = order[idx];
      if(!missed.includes(qIndex)) missed.push(qIndex);
    }
  }
  setHeader();
}

/* SPELLING */
function setSpellControlsEnabled(enabled){
  backspaceBtn.disabled = !enabled;
  clearBtn.disabled = !enabled;
  clueBtn.disabled = !enabled;
  submitSpellBtn.disabled = !enabled;

  const btns = letterBankEl.querySelectorAll("button");
  btns.forEach(b => {
    const used = b.dataset.used === "1";
    const locked = b.dataset.locked === "1";
    b.disabled = !enabled || used || locked;
  });
}

function initSpelling(q){
  spellTarget = q.word.toLowerCase();
  const letters = spellTarget.split("");

  revealed = new Array(letters.length).fill(false);
  buildStack = [];
  bankItems = [];
  spellFeedback.textContent = "";
  spellFeedback.className = "feedback";
  spellHint.innerHTML = `<strong>Hint:</strong> ${q.hint || "Use the clue sentence. If stuck, click Clue to reveal one letter."}`;

  const distractorPool = "aeiourstlnmdgpcvhtb".split("");
  const distractorCount = Math.min(6, Math.max(2, Math.floor(letters.length/4)));
  let distractors = [];
  while(distractors.length < distractorCount){
    distractors.push(distractorPool[Math.floor(Math.random()*distractorPool.length)]);
  }

  const bankLetters = shuffle([...letters, ...distractors]);
  bankItems = bankLetters.map((ch, i) => ({ id:`b${Date.now()}_${i}`, ch, used:false }));

  renderSpellingBlanks();
  renderLetterBank();

  backspaceBtn.onclick = () => doBackspace();
  clearBtn.onclick = () => doClear();
  clueBtn.onclick = () => revealOneLetter();
  submitSpellBtn.onclick = () => checkSpelling();

  // IMPORTANT: enable interaction FIRST, then start timer (prevents “couldn’t click anything”)
  activeSpell = true;
  setSpellControlsEnabled(true);

  // Reset countdown bar immediately
  timeLeft = SPELL_SECONDS;
  updateCountdownUI();

  // Start timer on next frame (ensures buttons are clickable before countdown begins)
  requestAnimationFrame(() => startSpellTimer(SPELL_SECONDS));
}

function renderSpellingBlanks(){
  const targetLetters = spellTarget.split("");
  const currentTyped = buildStack.filter(x => x.from === "bank").map(x => x.ch);
  let tIndex = 0;

  const display = targetLetters.map((ch, i)=>{
    if(revealed[i]) return ch.toUpperCase();
    if(tIndex < currentTyped.length){
      const out = currentTyped[tIndex].toUpperCase();
      tIndex += 1;
      return out;
    }
    return "_";
  });

  spellBlanks.textContent = display.join(" ");
}

function renderLetterBank(){
  letterBankEl.innerHTML = "";
  const lockAll = !activeSpell;

  bankItems.forEach((item)=>{
    const b = document.createElement("button");
    b.className = "letterBtn";
    b.textContent = item.ch.toUpperCase();
    b.dataset.id = item.id;
    b.dataset.used = item.used ? "1" : "0";
    b.dataset.locked = lockAll ? "1" : "0";
    b.disabled = lockAll || item.used;

    b.addEventListener("click", ()=>{
      if(!activeSpell) return;
      if(item.used) return;

      const blanksCount = revealed.filter(r => !r).length;
      const typedCount = buildStack.filter(x => x.from === "bank").length;
      if(typedCount >= blanksCount) return;

      item.used = true;
      buildStack.push({ id:item.id, ch:item.ch, from:"bank" });

      b.dataset.used = "1";
      b.disabled = true;
      renderSpellingBlanks();
    });

    letterBankEl.appendChild(b);
  });
}

function doBackspace(){
  if(!activeSpell) return;
  for(let i=buildStack.length-1;i>=0;i--){
    const node = buildStack[i];
    if(node.from === "bank"){
      buildStack.splice(i,1);

      const item = bankItems.find(x => x.id === node.id);
      if(item) item.used = false;

      const btn = letterBankEl.querySelector(`button[data-id="${node.id}"]`);
      if(btn){
        btn.dataset.used = "0";
        btn.disabled = false;
      }
      renderSpellingBlanks();
      return;
    }
  }
}

function doClear(){
  if(!activeSpell) return;

  buildStack = buildStack.filter(x => x.from !== "bank");
  bankItems.forEach(x => x.used = false);

  const btns = letterBankEl.querySelectorAll("button");
  btns.forEach(b=>{
    b.dataset.used = "0";
    b.disabled = false;
  });

  renderSpellingBlanks();
}

function revealOneLetter(){
  if(!activeSpell) return;

  const candidates = [];
  for(let i=0;i<revealed.length;i++){
    if(!revealed[i]) candidates.push(i);
  }
  if(candidates.length === 0) return;

  const pick = candidates[Math.floor(Math.random()*candidates.length)];
  revealed[pick] = true;

  spellFeedback.textContent = "Clue: one letter is revealed in the correct position.";
  spellFeedback.className = "feedback";
  renderSpellingBlanks();
}

function checkSpelling(){
  if(!activeSpell) return;

  attempts += 1;

  const targetLetters = spellTarget.split("");
  const remainingTarget = [];
  for(let i=0;i<targetLetters.length;i++){
    if(!revealed[i]) remainingTarget.push(targetLetters[i]);
  }

  const typed = buildStack.filter(x => x.from === "bank").map(x => x.ch.toLowerCase());

  if(typed.length !== remainingTarget.length){
    spellFeedback.textContent = "Fill all blanks first (or use Clue), then click Check.";
    spellFeedback.className = "feedback bad";
    return;
  }

  const ok = typed.join("") === remainingTarget.join("");

  if(ok){
    if(mode === "Main") correctCount += 1;

    spellFeedback.textContent = "Correct.";
    spellFeedback.className = "feedback good";
    nextBtn.disabled = false;

    activeSpell = false;
    stopSpellTimer();
    renderLetterBank();
    setSpellControlsEnabled(false);
  }else{
    spellFeedback.textContent = "Not yet. Try adjusting your letters (Backspace/Clear) or use Clue.";
    spellFeedback.className = "feedback bad";

    if(mode === "Main"){
      const qIndex = order[idx];
      if(!missed.includes(qIndex)) missed.push(qIndex);
    }
  }

  setHeader();
}

/* NAVIGATION */
nextBtn.addEventListener("click", ()=> goNext());
function goNext(){
  stopSpellTimer();
  activeSpell = false;

  idx += 1;
  const total = (mode === "Main") ? QUESTIONS.length : missed.length;

  if(idx < total){
    render();
  }else{
    if(mode === "Main" && missed.length > 0){
      startReview();
    }else{
      showEnd();
    }
  }
}

function startReview(){
  mode = "Review";
  idx = 0;
  missed = [...new Set(missed)];
  render();
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function listMissedWords(){
  const words = missed.map(i => QUESTIONS[i].word).filter(Boolean);
  const uniq = [...new Set(words)];
  return uniq.map(w=>`<li>${escapeHtml(w)}</li>`).join("");
}

function showEnd(){
  stopSpellTimer();
  activeSpell = false;

  const mainCard = document.querySelector(".layout .card .cardInner");
  const wrongCount = (mode === "Main") ? missed.length : 0;

  mainCard.innerHTML = `
    <div class="pill"><strong>Finished</strong> <span>• great work</span></div>
    <div class="qTitle">All done!</div>
    <div class="endBox">
      <div><strong>Correct:</strong> ${correctCount} / ${QUESTIONS.length}</div>
      <div style="margin-top:10px;">
        ${wrongCount > 0
          ? `You reviewed the questions you missed. If you still feel unsure, review these words:`
          : `You did not miss any questions in the main round.`}
      </div>
      ${wrongCount > 0 ? `<ul>${listMissedWords()}</ul>` : ``}
      <div style="margin-top:14px; color: rgba(255,255,255,0.75);">
        Reminder: If you are on a phone, turn it sideways for easier reading.
      </div>
      <div style="margin-top:14px;">
        <button class="btn primary" onclick="location.reload()">Restart (teacher)</button>
      </div>
    </div>
  `;

  modeText.textContent = "Complete";
  progressText.textContent = `25/25`;
  pbFill.style.width = `100%`;
  scoreText.textContent = correctCount;
  currentTaskTag.textContent = "Complete";
}

/* HINT BUTTON */
hintBtn.addEventListener("click", ()=>{
  const { q } = getCurrentQuestion();
  if(q.type === "spell") return;
  hintBox.innerHTML = `<strong>Hint:</strong> ${buildContextHint(q)}`;
});

/* RESET */
resetLink.addEventListener("click", ()=>{
  const ok = confirm("Reset the activity? (This restarts progress for students.)");
  if(ok) location.reload();
});

/* INIT */
renderVocabChips();
render();
</script>
</body>
</html>

