<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GA5 ‚Ä¢ Unit 4 ‚Äì Stumbling upon the Past (Vocabulary + Reading)</title>
  <style>
    :root{
      --bg0:#081423;
      --bg1:#0b1e33;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --stroke2: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --good: rgba(66, 245, 165, 0.95);
      --bad: rgba(255, 120, 120, 0.95);
      --warn: rgba(255, 214, 120, 0.95);
      --accent: rgba(120, 170, 255, 0.95);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius: 22px;
      --radius2: 16px;
      --font: "Century Gothic", "Trebuchet MS", Arial, sans-serif;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(120,170,255,0.16), transparent 65%),
        radial-gradient(900px 600px at 80% 30%, rgba(66,245,165,0.10), transparent 60%),
        radial-gradient(800px 520px at 55% 85%, rgba(255,170,90,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      justify-content:center;
      padding: 26px;
    }
    .shell{ width:min(1280px, 100%); display:flex; flex-direction:column; gap:18px; }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .head-left{ display:flex; align-items:center; gap:14px; min-width: 320px; }
    .logo{
      width:56px; height:56px; border-radius: 14px;
      background: rgba(255,255,255,0.10);
      border:1px solid var(--stroke2);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; flex: 0 0 auto;
    }
    .logo img{
      width: 42px; height: 42px; object-fit: contain; display:block;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.35));
    }
    .title-wrap{ display:flex; flex-direction:column; gap:6px; }
    .title{ font-size: 40px; line-height: 1.05; margin:0; font-weight: 700; }
    .subtitle{ margin:0; font-size: 18px; color: var(--muted); }

    .head-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      border-radius: 999px; padding: 10px 14px;
      background: rgba(255,255,255,0.07);
      border:1px solid var(--stroke);
      color: var(--muted);
      display:flex; gap:8px; align-items:center; min-height: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
    }
    .pill b{ color: var(--text); font-weight:700; }
    .bar{
      width: 220px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%; width: 0%;
      background: linear-gradient(90deg, rgba(120,170,255,0.95), rgba(66,245,165,0.90));
      border-radius: 999px;
      transition: width 260ms ease;
    }

    .grid{ display:grid; grid-template-columns: 1.55fr 0.95fr; gap: 18px; align-items:start; }
    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .main{ padding: 18px; min-height: 560px; }
    .side{
      padding: 16px; position:sticky; top: 18px;
      max-height: calc(100vh - 52px); overflow:auto;
    }

    .section-tag{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius: 999px;
      background: rgba(0,0,0,0.22);
      border:1px solid var(--stroke);
      color: var(--muted);
      margin-bottom: 12px; font-size: 16px;
    }
    .section-tag b{ color: var(--text); }
    .q-title{ font-size: 30px; margin: 4px 0 8px; line-height:1.15; }
    .q-sub{ margin: 0 0 12px; color: var(--muted); font-size: 16px; line-height: 1.4; }
    .prompt{ font-size: 22px; line-height: 1.35; margin: 10px 0 14px; white-space: pre-line; }

    .options{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .btn{
      font-family: var(--font);
      border-radius: 18px; padding: 16px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: var(--text);
      cursor:pointer; text-align:left;
      font-size: 20px; line-height:1.2; min-height: 60px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.085); border-color: rgba(255,255,255,0.18); }
    .btn:disabled{ cursor: default; opacity: 0.55; transform: none; }

    .controls{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      margin-top: 16px; padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    .left-controls,.right-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .soft{
      border-radius: 999px; padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: var(--text);
      cursor:pointer; font-size: 15px; font-family: var(--font);
    }
    .soft:hover{ background: rgba(255,255,255,0.085); }
    .primary{
      border-radius: 999px; padding: 12px 16px;
      background: linear-gradient(90deg, rgba(120,170,255,0.95), rgba(66,245,165,0.92));
      border: none; color: rgba(0,0,0,0.82);
      cursor:pointer; font-weight: 700; font-size: 16px; font-family: var(--font);
      box-shadow: 0 14px 35px rgba(0,0,0,0.28);
    }
    .primary:disabled{ opacity: 0.55; cursor: default; box-shadow:none; }

    .feedback{
      margin-top: 12px; padding: 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      min-height: 56px;
      display:flex; flex-direction:column; gap: 8px;
    }
    .line{ display:flex; gap: 10px; align-items:flex-start; color: var(--muted); font-size: 16px; line-height: 1.35; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }
    .warn{ color: var(--warn); }

    .side h3{ margin: 6px 0 10px; font-size: 18px; color: var(--text); }
    .side p,.side li{ color: var(--muted); line-height: 1.45; font-size: 14.5px; }
    .mini{
      border-radius: var(--radius2);
      background: rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.10);
      padding: 12px; margin-bottom: 12px;
    }
    .vocab-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px 10px; margin-top: 8px; }
    .chip{
      border-radius: 12px; padding: 10px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      font-size: 14px; color: var(--text); line-height: 1.2;
    }
    .muted-note{ color: var(--muted2); font-size: 12.5px; margin-top: 8px; }
    .hide{ display:none !important; }

    /* Spelling (tile click) */
    .spell-wrap{ display:flex; flex-direction:column; gap: 12px; margin-top: 8px; }
    .spell-target{
      border-radius: 18px; padding: 16px;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.12);
      min-height: 72px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap;
    }
    .spell-built{ font-size: 26px; letter-spacing: 0.6px; min-height: 32px; }
    .spell-hint{ color: var(--muted); font-size: 14px; text-align:right; }
    .tiles{ display:flex; flex-wrap:wrap; gap: 10px; }
    .tile{
      font-family: var(--font);
      border-radius: 14px; padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: var(--text);
      cursor:pointer;
      font-size: 18px;
      min-width: 44px;
      text-align:center;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .tile:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.085); border-color: rgba(255,255,255,0.18); }
    .tile:disabled{ opacity: 0.35; cursor: default; transform:none; }

    .excerpt{
      margin-top: 10px; padding: 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.85);
      font-size: 16px; line-height: 1.5; white-space: pre-line;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position:relative; top:auto; max-height:none; }
      .head-left{ min-width: unset; }
      .title{ font-size: 34px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="header card">
      <div class="head-left">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="GA logo" onerror="this.style.display='none'; this.parentElement.style.opacity='0.7';" />
        </div>
        <div class="title-wrap">
          <h1 class="title">Unit 4 ‚Äì Stumbling upon the Past</h1>
          <p class="subtitle">Vocabulary ‚Äì Meaning ‚Ä¢ Vocabulary ‚Äì Use ‚Ä¢ Vocabulary ‚Äì Spelling ‚Ä¢ Reading Comprehension</p>
        </div>
      </div>

      <div class="head-right">
        <div class="pill"><span>Progress:</span> <b id="progressText">1/25</b></div>
        <div class="pill"><span>Score:</span> <b id="scoreText">0</b></div>
        <div class="pill"><span>Mode:</span> <b id="modeText">Main</b></div>
        <div class="pill" style="gap:12px;">
          <span style="color:var(--muted);">Progress bar</span>
          <div class="bar" aria-label="Progress bar"><div id="progressBar"></div></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="main card">
        <div class="section-tag" id="sectionTag"><b>Vocabulary ‚Äì Meaning</b> <span id="sectionMini">‚Ä¢ meaning</span></div>

        <div class="q-title" id="qTitle">Question</div>
        <div class="q-sub" id="qSub">Read carefully. Use meaning + context.</div>

        <div class="prompt" id="prompt"></div>

        <!-- Multiple choice -->
        <div class="options" id="options"></div>

        <!-- Spelling (click tiles) -->
        <div class="spell-wrap hide" id="spellWrap">
          <div class="spell-target">
            <div>
              <div class="spell-built" id="spellBuilt">‚Äî</div>
              <div class="muted-note" id="spellNote">Click letters to build the word. Use Backspace if needed.</div>
            </div>
            <div class="spell-hint" id="spellPattern">Pattern clue: ‚Äî</div>
          </div>

          <div class="tiles" id="tiles"></div>

          <div class="left-controls">
            <button class="soft" id="backspaceBtn">Backspace</button>
            <button class="soft" id="clearBtn">Clear</button>
            <button class="soft hide" id="tryAgainBtn">Try again</button>
          </div>
        </div>

        <div class="feedback" id="feedback">
          <div class="line" id="fbLine1">Choose an answer. If you are wrong, you will get a helpful clue and you can try again.</div>
          <div class="line" id="fbLine2"></div>
        </div>

        <div class="controls">
          <div class="left-controls">
            <button class="soft" id="restartBtn" title="Restart the whole practice">Restart (teacher)</button>
          </div>
          <div class="right-controls">
            <button class="primary" id="nextBtn" disabled>Next</button>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="side card" id="sidebar">
        <div class="mini">
          <h3>How to do well</h3>
          <ul>
            <li><b>Meaning:</b> Think ‚ÄúWhat does the word mean?‚Äù</li>
            <li><b>Use:</b> Check the sentence idea. Which word fits best?</li>
            <li><b>Spelling:</b> Build the word carefully. If wrong, use the pattern clue and try again.</li>
            <li><b>Reading:</b> Re-read the excerpt and answer using evidence.</li>
          </ul>
          <p class="muted-note">Tip: Click Next only when you understand.</p>
        </div>

        <div class="mini" id="vocabBox">
          <h3>Vocabulary list</h3>
          <div class="vocab-grid" id="vocabGrid"></div>
          <p class="muted-note">This list will hide during Spelling.</p>
        </div>

        <div class="mini">
          <h3>Progress tips</h3>
          <ul>
            <li>If you miss a question, you can still keep trying (no skipping).</li>
            <li>Use <b>context</b>: who, where, what happened, why.</li>
            <li>Notice story verbs are in the <b>past</b> (discovered, examined, tripped).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const VOCAB = [
      "ash","dinosaur","discover","examine","excavate","layers",
      "paleontologist","pastime","ravine","sedimentary rock","skull",
      "determine","dream","favorite","tripped"
    ];

    // SAME excerpt for both RC questions (as requested)
    const RC_EXCERPT =
`‚ÄúThis bone was buried in sedimentary rock, which lies in layers under the ground. We‚Äôll look for volcanic ash below and above this rock layer. Through a special process, we can find out the ages of those layers of ash. Then we‚Äôll know that the dinosaur died sometime between those two ages.‚Äù`;

    // 25 TOTAL:
    // 10 Meaning, 8 Use, 5 Spelling, 2 Reading Comprehension (same excerpt)
    const QUESTIONS = [
      // =======================
      // VOCAB ‚Äì MEANING (10)
      // =======================
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"paleontologist",
        prompt:"Which word means:\nA scientist who studies fossils and ancient life on Earth?",
        options:["paleontologist","pastime","dinosaur","dream"], answer:0,
        hint:"Look for the job word (a kind of scientist)."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"dinosaur",
        prompt:"Which word means:\nAn extinct animal that lived millions of years ago (often very large)?",
        options:["dinosaur","skull","ravine","ash"], answer:0,
        hint:"This animal is not alive today."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"ravine",
        prompt:"Which word means:\nA deep, narrow valley or gap in the ground (often with steep sides)?",
        options:["layers","ravine","ash","pastime"], answer:1,
        hint:"In the story, Javier runs down into this place."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"skull",
        prompt:"Which word means:\nThe hard bone of the head that protects the brain?",
        options:["skull","dinosaur","layers","ash"], answer:0,
        hint:"It is a body part (head bone)."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"ash",
        prompt:"Which word means:\nThe soft gray powder left after something burns (like wood)?",
        options:["ash","layers","sedimentary rock","pastime"], answer:0,
        hint:"Think of what is left after a fire."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"layers",
        prompt:"Which word means:\nLevels of material placed on top of each other?",
        options:["layers","ravine","dream","tripped"], answer:0,
        hint:"Think: stacked levels."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"sedimentary rock",
        prompt:"Which phrase means:\nRock made over time from small pieces that press together in layers?",
        options:["sedimentary rock","ash","skull","pastime"], answer:0,
        hint:"This is a type of rock."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"pastime",
        prompt:"Which word means:\nAn activity you do for fun in your free time?",
        options:["pastime","determine","excavate","examine"], answer:0,
        hint:"It is something you do for enjoyment."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"determine",
        prompt:"Which word means:\nTo find out something by checking evidence or using a process?",
        options:["determine","discover","dream","tripped"], answer:0,
        hint:"This means ‚Äòto figure out‚Äô using evidence."
      },
      { section:"Vocabulary ‚Äì Meaning", type:"mc", word:"tripped",
        prompt:"Which word means:\nTo stumble because your foot hits something?",
        options:["favorite","tripped","excavate","layers"], answer:1,
        hint:"It happens when your foot catches on something."
      },

      // =======================
      // VOCAB ‚Äì USE (8)
      // =======================
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"discovered",
        prompt:"Choose the best word:\nIn 2003, scientists __________ dinosaur bones near the village.",
        options:["discovered","dream","layers","skull"], answer:0,
        hint:"This sentence is about finding something for the first time."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"examined",
        prompt:"Choose the best word:\nThe paleontologist came to the ravine and __________ the boy‚Äôs discovery carefully.",
        options:["examined","tripped","favorite","ash"], answer:0,
        hint:"A scientist looks closely and checks details."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"ravine",
        prompt:"Choose the best word:\nJavier ran down into the __________ to get the kite.",
        options:["ravine","layers","pastime","skull"], answer:0,
        hint:"This is a place in the ground (a deep gap/valley)."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"sedimentary rock",
        prompt:"Choose the best phrase:\nThe bone was buried in __________ under the ground.",
        options:["sedimentary rock","pastime","favorite","dream"], answer:0,
        hint:"This is a type of rock mentioned in the text."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"layers",
        prompt:"Choose the best word:\nVolcanic ash can be found above and below different rock __________.",
        options:["layers","ravines","skulls","pastimes"], answer:0,
        hint:"Think: stacked levels."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"excavating",
        prompt:"Choose the best word:\nSoon, the team began __________ the area around the bone to find more pieces.",
        options:["excavating","dream","favorite","tripped"], answer:0,
        hint:"This means digging carefully to uncover something."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"determine",
        prompt:"Choose the best word:\nScientists use evidence to __________ how old the bone is.",
        options:["determine","discover","tripped","skull"], answer:0,
        hint:"This means to find out the answer."
      },
      { section:"Vocabulary ‚Äì Use", type:"mc", word:"pastime",
        prompt:"Choose the best word:\nExploring outside can be a fun __________.",
        options:["pastime","ash","ravine","skull"], answer:0,
        hint:"It is an activity you do for fun."
      },

      // =======================
      // VOCAB ‚Äì SPELLING (5) ‚Äî click tiles
      // =======================
      { section:"Vocabulary ‚Äì Spelling", type:"spell", word:"paleontologist",
        prompt:"Spelling (click to build):\nA scientist who studies fossils and ancient life.", clueStart:3 },
      { section:"Vocabulary ‚Äì Spelling", type:"spell", word:"sedimentary rock",
        prompt:"Spelling (click to build):\nThe type of rock the bone was buried in (two words).", clueStart:3 },
      { section:"Vocabulary ‚Äì Spelling", type:"spell", word:"ravine",
        prompt:"Spelling (click to build):\nA deep narrow valley in the ground.", clueStart:2 },
      { section:"Vocabulary ‚Äì Spelling", type:"spell", word:"excavate",
        prompt:"Spelling (click to build):\nTo dig carefully to uncover something.", clueStart:2 },
      { section:"Vocabulary ‚Äì Spelling", type:"spell", word:"determine",
        prompt:"Spelling (click to build):\nTo find out by using evidence.", clueStart:2 },

      // =======================
      // READING COMPREHENSION (2) ‚Äî SAME excerpt
      // =======================
      { section:"Reading Comprehension", type:"mc", word:"RC1",
        prompt:"Read the excerpt. Then answer:\nWhy does the paleontologist talk about volcanic ash and rock layers?\n\n(Choose the best answer.)",
        excerpt: RC_EXCERPT,
        options:[
          "To estimate the dinosaur‚Äôs age by comparing the ages of ash layers above and below the rock layer",
          "To prove that the bone is made of ash instead of rock",
          "To explain why the village has a ravine near the field",
          "To show that dinosaurs are still alive today"
        ],
        answer:0,
        hint:"The excerpt explains: ages of ash layers ‚Üí time range for when the dinosaur died."
      },
      { section:"Reading Comprehension", type:"mc", word:"RC2",
        prompt:"Read the excerpt. Then answer:\nWhat does the phrase ‚Äúbetween those two ages‚Äù mean here?\n\n(Choose the best answer.)",
        excerpt: RC_EXCERPT,
        options:[
          "The dinosaur died after the older ash layer formed and before the younger ash layer formed",
          "The dinosaur died exactly when the ash layers formed",
          "The dinosaur died long before any ash layers existed",
          "The dinosaur died at the same time as the rock was created"
        ],
        answer:0,
        hint:"‚ÄòBetween‚Äô means after one time point and before the other."
      }
    ];

    // Sidebar vocab chips
    const vocabGrid = document.getElementById("vocabGrid");
    VOCAB.forEach(w => {
      const d = document.createElement("div");
      d.className = "chip";
      d.textContent = w;
      vocabGrid.appendChild(d);
    });

    // UI refs
    const sectionTag = document.getElementById("sectionTag");
    const qTitle = document.getElementById("qTitle");
    const qSub = document.getElementById("qSub");
    const promptEl = document.getElementById("prompt");
    const optionsEl = document.getElementById("options");
    const feedback1 = document.getElementById("fbLine1");
    const feedback2 = document.getElementById("fbLine2");
    const nextBtn = document.getElementById("nextBtn");
    const restartBtn = document.getElementById("restartBtn");

    const progressText = document.getElementById("progressText");
    const scoreText = document.getElementById("scoreText");
    const modeText = document.getElementById("modeText");
    const progressBar = document.getElementById("progressBar");

    const vocabBox = document.getElementById("vocabBox");

    // spelling UI
    const spellWrap = document.getElementById("spellWrap");
    const spellBuilt = document.getElementById("spellBuilt");
    const tilesEl = document.getElementById("tiles");
    const backspaceBtn = document.getElementById("backspaceBtn");
    const clearBtn = document.getElementById("clearBtn");
    const tryAgainBtn = document.getElementById("tryAgainBtn");
    const spellPattern = document.getElementById("spellPattern");

    // State
    let score = 0;
    let idx = 0;
    let mode = "Main";

    // spelling state
    let built = "";
    let tilePool = [];
    let tileUsed = [];

    function setFeedback(line1, line2, tone){
      feedback1.className = "line";
      feedback2.className = "line";
      feedback1.textContent = line1 || "";
      feedback2.textContent = line2 || "";
      if(tone === "good") feedback1.classList.add("good");
      if(tone === "bad") feedback1.classList.add("bad");
      if(tone === "warn") feedback1.classList.add("warn");
    }

    function updateHeader(){
      const total = QUESTIONS.length; // EXACT total (25)
      const currentNum = Math.min(idx + 1, total);
      progressText.textContent = `${currentNum}/${total}`;
      scoreText.textContent = `${score}`;
      modeText.textContent = mode;
      const pct = Math.round((currentNum / total) * 100);
      progressBar.style.width = `${pct}%`;
    }

    function patternClue(word, clueStart){
      const parts = word.split(" ");
      const out = parts.map(p => {
        const n = Math.min(clueStart, p.length);
        return p.slice(0, n) + "_".repeat(Math.max(0, p.length - n));
      });
      return out.join(" ");
    }

    function makeTiles(word){
      const chars = word.split("");
      for(let i = chars.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [chars[i], chars[j]] = [chars[j], chars[i]];
      }
      return chars;
    }

    function showQuestion(){
      const q = QUESTIONS[idx];
      nextBtn.disabled = true;

      // Section tag
      sectionTag.innerHTML = `<b>${q.section}</b> <span>‚Ä¢ ${q.section.includes("Spelling") ? "click letters to spell" : "choose the best answer"}</span>`;
      qTitle.textContent = q.section;
      qSub.textContent = "If you are wrong, you will get a clue and you can try again. Click Next only when you understand.";

      // Reset feedback
      setFeedback("Choose an answer. If you are wrong, you will get a helpful clue and you can try again.", "", "");

      // Hide vocab box during spelling
      if(q.type === "spell") vocabBox.classList.add("hide");
      else vocabBox.classList.remove("hide");

      // Prompt
      promptEl.textContent = q.prompt;

      // Excerpt handling
      const existingExcerpt = document.getElementById("excerptBox");
      if(existingExcerpt) existingExcerpt.remove();
      if(q.excerpt){
        const ex = document.createElement("div");
        ex.id = "excerptBox";
        ex.className = "excerpt";
        ex.textContent = q.excerpt;
        promptEl.insertAdjacentElement("afterend", ex);
      }

      // Areas
      optionsEl.innerHTML = "";
      spellWrap.classList.add("hide");
      tryAgainBtn.classList.add("hide");

      if(q.type === "mc") renderMultipleChoice(q);
      if(q.type === "spell") renderSpelling(q);

      updateHeader();
    }

    function renderMultipleChoice(q){
      q.options.forEach((opt, i) => {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = opt;
        b.addEventListener("click", () => handleMCAnswer(q, i));
        optionsEl.appendChild(b);
      });
    }

    function handleMCAnswer(q, choice){
      const buttons = Array.from(optionsEl.querySelectorAll("button.btn"));

      if(choice === q.answer){
        buttons.forEach(btn => btn.disabled = true);
        setFeedback("Correct. üôÇ", "Click Next when you understand why.", "good");
        nextBtn.disabled = false;
        score++;
      }else{
        setFeedback("Not yet. Try again.", `Clue: ${q.hint}`, "warn");
      }
    }

    function renderSpelling(q){
      spellWrap.classList.remove("hide");
      built = "";
      spellBuilt.textContent = "‚Äî";

      const clueStart = q.clueStart ?? 2;
      spellPattern.textContent = `Pattern clue: ${patternClue(q.word, clueStart)}`;

      tilePool = makeTiles(q.word);
      tileUsed = new Array(tilePool.length).fill(false);
      tilesEl.innerHTML = "";

      tilePool.forEach((ch, i) => {
        const t = document.createElement("button");
        t.className = "tile";
        t.textContent = (ch === " ") ? "‚ê†" : ch;
        t.title = (ch === " ") ? "space" : ch;
        t.addEventListener("click", () => {
          if(tileUsed[i]) return;
          tileUsed[i] = true;
          t.disabled = true;
          built += ch;
          spellBuilt.textContent = built || "‚Äî";
          if(built.length === q.word.length) checkSpelling(q);
        });
        tilesEl.appendChild(t);
      });

      backspaceBtn.onclick = () => {
        if(!built.length) return;
        const removed = built[built.length - 1];
        built = built.slice(0, -1);
        spellBuilt.textContent = built || "‚Äî";

        const tiles = Array.from(tilesEl.querySelectorAll("button.tile"));
        for(let i = tileUsed.length - 1; i >= 0; i--){
          if(tileUsed[i] && tilePool[i] === removed){
            tileUsed[i] = false;
            tiles[i].disabled = false;
            break;
          }
        }
        nextBtn.disabled = true;
        tryAgainBtn.classList.add("hide");
        setFeedback("Keep building the word.", "Tip: use the pattern clue and check letter order.", "");
      };

      clearBtn.onclick = () => resetSpelling(q);
      tryAgainBtn.onclick = () => resetSpelling(q);

      setFeedback("Spelling: click the letters to build the word.", "If you are wrong, click Try again and use the pattern clue.", "");
    }

    function resetSpelling(q){
      built = "";
      spellBuilt.textContent = "‚Äî";
      nextBtn.disabled = true;

      const tiles = Array.from(tilesEl.querySelectorAll("button.tile"));
      tileUsed = tileUsed.map(() => false);
      tiles.forEach(t => t.disabled = false);

      tryAgainBtn.classList.add("hide");
      setFeedback("Try again.", "Use the pattern clue (some letters are already shown).", "warn");
    }

    function checkSpelling(q){
      if(built === q.word){
        setFeedback("Correct spelling. üôÇ", "Click Next when you are ready.", "good");
        nextBtn.disabled = false;
        score++;
        tryAgainBtn.classList.add("hide");
      }else{
        setFeedback("Not correct yet.", "Click Try again and use the pattern clue.", "warn");
        tryAgainBtn.classList.remove("hide");
        nextBtn.disabled = true;
      }
    }

    nextBtn.addEventListener("click", () => {
      idx++;
      if(idx < QUESTIONS.length){
        showQuestion();
      }else{
        endScreen();
      }
    });

    function endScreen(){
      const existingExcerpt = document.getElementById("excerptBox");
      if(existingExcerpt) existingExcerpt.remove();

      sectionTag.innerHTML = `<b>Finished</b> <span>‚Ä¢ well done</span>`;
      qTitle.textContent = "All done!";
      qSub.textContent = "You have finished the practice.";
      promptEl.textContent = `Final score: ${score} / ${QUESTIONS.length}\n\nReview suggestion:\nRe-read the excerpt and check how scientists use evidence (layers + ash) to determine age.`;

      optionsEl.innerHTML = "";
      spellWrap.classList.add("hide");
      vocabBox.classList.remove("hide");
      nextBtn.disabled = true;

      setFeedback("Great work.", "If you want to practice again, use Restart (teacher).", "good");

      progressText.textContent = `${QUESTIONS.length}/${QUESTIONS.length}`;
      progressBar.style.width = `100%`;
      modeText.textContent = "Done";
    }

    restartBtn.addEventListener("click", () => {
      const ok = confirm("Restart the whole practice? (Students should not click this.)");
      if(!ok) return;
      score = 0;
      idx = 0;
      mode = "Main";
      const existingExcerpt = document.getElementById("excerptBox");
      if(existingExcerpt) existingExcerpt.remove();
      showQuestion();
    });

    // Start
    showQuestion();
  </script>
</body>
</html>


